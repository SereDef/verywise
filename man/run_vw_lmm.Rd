% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_vw_lmm.R
\name{run_vw_lmm}
\alias{run_vw_lmm}
\title{Run vertex-wise linear mixed model using \code{lme4::lmer()}}
\usage{
run_vw_lmm(
  formula,
  pheno,
  subj_dir,
  outp_dir = NULL,
  hemi = c("lh", "rh"),
  folder_id = "folder_id",
  seed = 3108,
  n_cores = 1,
  chunk_size = 1000,
  FS_HOME = Sys.getenv("FREESURFER_HOME"),
  fs_template = "fsaverage",
  apply_cortical_mask = TRUE,
  use_model_template = TRUE,
  save_ss = TRUE,
  verbose = TRUE,
  fwhm = 10,
  mcz_thr = 30,
  cwp_thr = 0.025
)
}
\arguments{
\item{formula}{A model formula object. This should specify a linear mixed model
\code{lme4} syntax. The outcome variable should be one of the supported brain
surface metrics (see Details). Example: 
\code{vw_thickness ~ age * sex + site + (1|participant_id)}.}

\item{pheno}{Either a \code{data.frame}/\code{tibble} containing the "phenotype" data 
(i.e., already loaded in the global environment), or a string specifying the
file path to phenotype data. Supported file formats: .rds, 
.csv, .txt, .sav (SPSS). 
The data should be in \strong{long} format and it should contain all the variables 
specified in the \code{formula} plus the \code{folder_id} column.}

\item{subj_dir}{Character string specifying the path to FreeSurfer data directory.
Must follow the verywise directory structure (see package vignette for details).}

\item{outp_dir}{Character string specifying the output directory for results.
If \code{NULL} (default), creates a "verywise_results" subdirectory within 
\code{subj_dir}.}

\item{hemi}{Character string specifying which hemisphere(s) to analyze.
Options: \code{"both"} (default), \code{"lh"} (left only), \code{"rh"} (right only).}

\item{folder_id}{Character string specifying the column name in \code{pheno}
that contains subject directory names of the input neuroimaging data 
(e.g., "sub-001_ses-baseline" or "site1/sub-010_ses-F1"). These are expected to be nested 
inside \code{subj_dir}.
Default: \code{"folder_id"}.}

\item{seed}{Integer specifying the random seed for reproducibility. Default: 3108.}

\item{n_cores}{Integer specifying the number of CPU cores for parallel processing.
Default: 1.}

\item{chunk_size}{Integer specifying the number of vertices processed per chunk
in parallel operations. Larger values use more memory but may be faster.
Default: 1000.}

\item{FS_HOME}{Character string specifying the FreeSurfer home directory.
Defaults to \code{FREESURFER_HOME} environment variable.}

\item{fs_template}{Character string specifying the FreeSurfer template for
  vertex registration. Options: 
  \itemize{
  \item \code{"fsaverage"} (default) = 163842 vertices (highest resolution),
  \item \code{"fsaverage6"} = 40962 vertices,
  \item \code{"fsaverage5"} = 10242 vertices,
  \item \code{"fsaverage4"} = 2562 vertices,
  \item \code{"fsaverage3"} = 642 vertices
}
Note that lower resolutions should be only used to downsample the brain map, for faster
model tuning. The final analyses should also run using \code{fs_template = "fsaverage"}
to avoid (small) imprecisions in vertex registration and smoothing.}

\item{apply_cortical_mask}{Logical indicating whether to exclude non-cortical
vertices from analysis. Default: \code{TRUE} (recommended).}

\item{use_model_template}{Logical indicating whether to pre-compile the model
template for faster estimation. Default: \code{TRUE} (recommended).}

\item{save_ss}{Logical indicating whether to save the super-subject matrix as
an .rds file for faster future processing. Default: \code{TRUE} (recommended).}

\item{verbose}{Logical indicating whether to display progress messages.
Default: \code{TRUE}.}

\item{fwhm}{Numeric value specifying the full-width half-maximum for smoothing
kernel. Default: 10.}

\item{mcz_thr}{Numeric value for Monte Carlo simulation threshold. 
  Any of the following are accepted (equivalent values separate by \code{/}):
  \itemize{
  \item 13 / 1.3 / 0.05,
  \item 20 / 2.0 / 0.01,
  \item 23 / 2.3 / 0.005,
  \item 30 / 3.0 / 0.001, \* default
  \item 33 / 3.3 / 0.0005,
  \item 40 / 4.0 / 0.0001.
}}

\item{cwp_thr}{Numeric value for cluster-wise p-value threshold (on top of all corrections).
Set this to 0.025 when both hemispheres are analyzed, 0.05 for single hemisphere. 
Default: 0.025.}
}
\value{
A list of file-backed matrices (\code{bigstatsr::FBM} objects) containing pooled 
coefficients, SEs, t- and p- values and residuals.
Results are also automatically saved to disk in .mgh format.
}
\description{
This is is the main function for conducting vertex-wise linear mixed model analyses
on brain surface metrics. It will first check use inputs, prepare the phenotype data(list) 
and run a linear mixed model at each vertex of the specified hemisphere using the 
\code{\link{single_lmm}} function. 

The function supports analysis of both single and multiple imputed datasets.
It also automatically handles cortical masking, and provides cluster-wise correction
for multiple testing using FreeSurfer's Monte Carlo simulation approach.
}
\details{
\strong{Supported Brain Surface Metrics:}
The outcome specified in \code{formula} should be a brain surface metric among:
\itemize{
  \item \code{vw_thickness} - Cortical thickness
  \item \code{vw_area} - Cortical surface area (white  surface)
  \item \code{vw_area.pial} - Cortical surface area (pial surface)
  \item \code{vw_curv} - Mean curvature
  \item \code{vw_jacobian_white} - Jacobian determinant (white surface)
  \item \code{vw_pial} - Pial surface coordinates
  \item \code{vw_pial_lgi} - Local gyrification index (pial surface)
  \item \code{vw_sulc} - Sulcal depth
  \item \code{vw_volume} - Gray matter volume
  \item \code{vw_w_g.pct} - White/gray matter intensity ratio
  \item \code{vw_white.H} - Mean curvature (white surface)
  \item \code{vw_white.K} - Gaussian curvature (white surface)
}

\strong{Statistical Approach:}
The function uses \code{lme4::lmer()} for mixed-effects modeling, enabling
analysis of longitudinal and hierarchical data. P-values are computed using
the t-as-z approximation, with cluster-wise correction applied using FreeSurfer's
Monte Carlo simulation approach.

\strong{Multiple Imputation:}
The function automatically detects and handles multiple imputed datasets
(created with \code{mice} or similar packages), pooling results according
to Rubin's rules.

\strong{Parallel processing:}
The \code{verywise} package employs a carefully designed parallelization strategy 
to maximize computational efficiency while avoiding the performance penalties 
associated with nested parallelization.
Left and right cortical hemispheres are processed sequentially by default, unless specified otherwise
in the SLURM call (or similar, see vignette on parallelisation [COMING UP])
Within each hemisphere, vertices are divided into chunks of size \code{chunk_size} and processed 
in parallel across \code{n_cores} workers (when \code{n_cores > 1}).
When multiple imputed datasets are present, they are processed sequentially within each vertex.

Note that, on some systems, implicit parallelism in low-level matrix algebra libraries 
(BLAS/LAPACK) can interfere with explicit parallelization. If you feel like processing is 
taking too long, we recommend disabling these implicit threading libraries before starting R.
For example:
\preformatted{
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1  
export MKL_NUM_THREADS=1
export VECLIB_MAXIMUM_THREADS=1
export NUMEXPR_NUM_THREADS=1
}

\strong{Output Files:}
Results are saved in FreeSurfer-compatible .mgh format for visualization
with [verywiseWIZard](https://github.com/SereDef/verywise-wizard), FreeView or 
other neuroimaging software.
}
\note{
\itemize{
  \item Ensure FreeSurfer is properly installed and the \code{FREESURFER_HOME}
    environment variable is set.
  \item Large datasets may require substantial memory. Consider adjusting
    \code{chunk_size} and \code{n_cores} based on your system specifications.
  \item For reproducibility, always specify a \code{seed}.
}
}
\examples{
# Basic cortical thickness analysis
\dontrun{
results <- run_vw_lmm(
  formula = vw_thickness ~ age + sex + site + (1|participant_id),
  pheno = "path/to/phentype/data", # or data.frame object 
  subj_dir = "/path/to/freesurfer/subjects",
  outp_dir = "/path/to/output",
  hemi = "lh",
  n_cores = 4)
}

}
\seealso{
\code{\link{single_lmm}} for single-vertex modeling,
\code{vignette("03-run-vw-lmm", package = "verywise")} for detailed usage examples.
}
\author{
Serena Defina, 2024.
}
