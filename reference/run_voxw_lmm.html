<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run voxel-wise linear mixed model using lme4::lmer() — run_voxw_lmm • verywise</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run voxel-wise linear mixed model using lme4::lmer() — run_voxw_lmm"><meta name="description" content="This is is the main function for conducting voxel-wise linear mixed model
analyses on brain morphology. It will first check use inputs, prepare
the phenotype data(list) and run a linear mixed model at each voxel using
the single_lmm function.
The function supports analysis of both single and multiple imputed datasets.
–TODO– It also automatically handles roi masking, and provides cluster-wise
correction for multiple testing using cluster size permutation."><meta property="og:description" content="This is is the main function for conducting voxel-wise linear mixed model
analyses on brain morphology. It will first check use inputs, prepare
the phenotype data(list) and run a linear mixed model at each voxel using
the single_lmm function.
The function supports analysis of both single and multiple imputed datasets.
–TODO– It also automatically handles roi masking, and provides cluster-wise
correction for multiple testing using cluster size permutation."><meta property="og:image" content="https://seredef.github.io/verywise/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">verywise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/00-installation-sys-requirements.html">Get ready - step 1: Installation and system requirements</a></li>
    <li><a class="dropdown-item" href="../articles/01-format-data.html">Get ready - step 2: preparing your data</a></li>
    <li><a class="dropdown-item" href="../articles/02-simulate-data.html">Optional: simulating data</a></li>
    <li><a class="dropdown-item" href="../articles/03-run-vw-lmm.html">Running vertex-wise linear mixed models</a></li>
    <li><a class="dropdown-item" href="../articles/04-run-slurm-array.html">Run many `verywise` analyses in parallel (on SLURM)</a></li>
    <li><a class="dropdown-item" href="../articles/05-visualize-results.html">Extracting and visualizing `verywise` results</a></li>
    <li><a class="dropdown-item" href="../articles/06-run-vw-meta.html">Running vertex-wise meta-analyses</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SereDef/verywise/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run voxel-wise linear mixed model using <code>lme4::lmer()</code></h1>
      <small class="dont-index">Source: <a href="https://github.com/SereDef/verywise/blob/main/R/run_voxw_lmm.R" class="external-link"><code>R/run_voxw_lmm.R</code></a></small>
      <div class="d-none name"><code>run_voxw_lmm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This is is the main function for conducting voxel-wise linear mixed model
analyses on brain morphology. It will first check use inputs, prepare
the phenotype data(list) and run a linear mixed model at each voxel using
the <code><a href="single_lmm.html">single_lmm</a></code> function.</p>
<p>The function supports analysis of both single and multiple imputed datasets.
–TODO– It also automatically handles roi masking, and provides cluster-wise
correction for multiple testing using cluster size permutation.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">run_voxw_lmm</span><span class="op">(</span></span>
<span>  <span class="va">formula</span>,</span>
<span>  <span class="va">pheno</span>,</span>
<span>  <span class="va">ss_file</span>,</span>
<span>  outp_dir <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  brain_template <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  apply_mask <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  weights <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  lmm_control <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">3108</span>,</span>
<span>  n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  save_residuals <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-formula">formula<a class="anchor" aria-label="anchor" href="#arg-formula"></a></dt>
<dd><p>A model formula object. This should specify a linear mixed
model <code>lme4</code> syntax. The outcome variable should be one of the
supported brain surface metrics (see Details). Example:
<code>vw_value ~ age * sex + site + (1|participant_id)</code>.</p></dd>


<dt id="arg-pheno">pheno<a class="anchor" aria-label="anchor" href="#arg-pheno"></a></dt>
<dd><p>Either a <code>data.frame</code>/<code>tibble</code> containing the
"phenotype" data (i.e., already loaded in the global environment), or a
string specifying the file path to phenotype data. Supported file formats:
.rds, .csv, .txt, .sav (SPSS).
The data should be in <strong>long</strong> format and it should contain all the
variables specified in the left-hand side of the <code>formula</code> (i.e., after the <code>~</code>)
–TODO: no checking done so far– plus the <code>obs_id</code> column.</p></dd>


<dt id="arg-ss-file">ss_file<a class="anchor" aria-label="anchor" href="#arg-ss-file"></a></dt>
<dd><p>A path to the super-subject matrix file (observations by voxels). The
rows are assumed in the same order as the phenotype. .csv formats are currently
supported.</p></dd>


<dt id="arg-outp-dir">outp_dir<a class="anchor" aria-label="anchor" href="#arg-outp-dir"></a></dt>
<dd><p>Character string specifying the output directory for results.
If <code>NULL</code> (default), creates a "results" sub-directory in the
current working directory (not recommended).</p></dd>


<dt id="arg-brain-template">brain_template<a class="anchor" aria-label="anchor" href="#arg-brain-template"></a></dt>
<dd><p>Character string specifying the brain template for
voxel registration. TMP: number of voxels. Options: –TODO–</p></dd>


<dt id="arg-apply-mask">apply_mask<a class="anchor" aria-label="anchor" href="#arg-apply-mask"></a></dt>
<dd><p>Logical vector for ROI masking –TODO–</p></dd>


<dt id="arg-weights">weights<a class="anchor" aria-label="anchor" href="#arg-weights"></a></dt>
<dd><p>Optional string or numeric vector of weights for the linear mixed model.
You can use this argument to specify inverse-probability weights. If this
is a string, the function look for a column with that name in the phenotype
data. Note that these are not normalized or standardized in any way.
Default: <code>NULL</code> (no weights).</p></dd>


<dt id="arg-lmm-control">lmm_control<a class="anchor" aria-label="anchor" href="#arg-lmm-control"></a></dt>
<dd><p>Optional list (of correct class, resulting from
<code>lmerControl()</code> containing control parameters to be passed to
<code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code> (e.g. optimizer choice, convergence criteria,
see the <code>?lmerControl</code> documentation for details.
Default: (uses default settings).</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Integer specifying the random seed for reproducibility
Default: 3108.</p></dd>


<dt id="arg-n-cores">n_cores<a class="anchor" aria-label="anchor" href="#arg-n-cores"></a></dt>
<dd><p>Integer specifying the number of CPU cores for parallel
processing.
Default: 1.</p></dd>


<dt id="arg-chunk-size">chunk_size<a class="anchor" aria-label="anchor" href="#arg-chunk-size"></a></dt>
<dd><p>Integer specifying the number of vertices processed per
chunk in parallel operations. Larger values use more memory but may be
faster.
Default: 1000.</p></dd>


<dt id="arg-save-residuals">save_residuals<a class="anchor" aria-label="anchor" href="#arg-save-residuals"></a></dt>
<dd><p>Logical indicating whether to save the residuals.csv
file. Default: <code>FALSE</code>.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical indicating whether to display progress messages.
Default: <code>TRUE</code>.</p>
<p><strong>Statistical Approach:</strong>
The function uses <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code> for mixed-effects modeling, enabling
analysis of longitudinal and hierarchical data. P-values are computed using
the t-as-z approximation, with cluster-wise correction applied using
–TODO–.</p>
<p><strong>Multiple Imputation:</strong>
The function automatically detects and handles multiple imputed datasets
(created with <code>mice</code> or similar packages), pooling results according
to Rubin's rules.</p>
<p><strong>Parallel processing:</strong>
The <code>verywise</code> package employs a carefully designed parallelization
strategy to maximize computational efficiency while avoiding the
performance penalties associated with nested parallelization.
Parallel processing of multiple models should be handled by the user
(e.g., using SLURM job arrays or similar, see vignette on parallelisation).
Within a single run_voxw_lmm call, voxels are divided into chunks of size
<code>chunk_size</code> and processed in parallel across <code>n_cores</code> workers
(when <code>n_cores &gt; 1</code>). When multiple imputed datasets are present,
these are processed sequentially within each voxel.</p>
<p>Note that, on some systems, implicit parallelism in low-level matrix algebra
libraries (BLAS/LAPACK) can interfere with explicit parallelization. If you
feel like processing is taking too long, I recommend disabling these implicit
threading libraries before starting R.
For example:</p><div class="sourceCode"><pre><code>
export OPENBLAS_NUM_THREADS=1
export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export VECLIB_MAXIMUM_THREADS=1
export NUMEXPR_NUM_THREADS=1
</code></pre></div>

<p>Also note that using a very large number of cores (e.g. &gt;120) may sometimes
cause worker initialization or other issues (e.g. R parallel processes
limits)</p>
<p><strong>Output Files:</strong>
Results are saved in –TODO– format for visualization
with –TODO–</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list of file-backed matrices (<code><a href="https://privefl.github.io/bigstatsr/reference/FBM-class.html" class="external-link">bigstatsr::FBM</a></code> objects)
containing pooled coefficients, SEs, t- and p- values and residuals.
Results are also automatically saved to disk in –TODO– format.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>

<ul><li><p>Large datasets may require substantial memory. Consider adjusting
<code>chunk_size</code> and <code>n_cores</code> based on your system specifications.</p></li>
<li><p>For reproducibility, always specify a <code>seed</code>.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="single_lmm.html">single_lmm</a></code> for single-voxel modeling</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Serena Defina, 2026.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Serena Defina, Ryan Muetzel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

