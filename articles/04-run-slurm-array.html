<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Run many `verywise` analyses in parallel (on SLURM) • verywise</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run many `verywise` analyses in parallel (on SLURM)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">verywise</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/00-installation-sys-requirements.html">Get ready - step 1: Installation and system requirements</a></li>
    <li><a class="dropdown-item" href="../articles/01-format-data.html">Get ready - step 2: preparing your data</a></li>
    <li><a class="dropdown-item" href="../articles/02-simulate-data.html">Optional: simulating data</a></li>
    <li><a class="dropdown-item" href="../articles/03-run-vw-lmm.html">Running vertex-wise linear mixed models</a></li>
    <li><a class="dropdown-item" href="../articles/04-run-slurm-array.html">Run many `verywise` analyses in parallel (on SLURM)</a></li>
    <li><a class="dropdown-item" href="../articles/05-visualize-results.html">Extracting and visualizing `verywise` results</a></li>
    <li><a class="dropdown-item" href="../articles/06-run-vw-meta.html">Running vertex-wise meta-analyses</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SereDef/verywise/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run many `verywise` analyses in parallel (on SLURM)</h1>
                        <h4 data-toc-skip class="author">Serena
Defina</h4>
            
            <h4 data-toc-skip class="date">2026-02-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SereDef/verywise/blob/main/vignettes/articles/04-run-slurm-array.Rmd" class="external-link"><code>vignettes/articles/04-run-slurm-array.Rmd</code></a></small>
      <div class="d-none name"><code>04-run-slurm-array.Rmd</code></div>
    </div>

    
    
<p>The <code>run_vw_*()"</code> functions from <code>verywise</code> are
designed to run a single vertex-wise analysis: i.e. a single model and
in only one hemisphere. This is done on purpose, to keep things simple
and modular, and maximise computational efficiency, while avoiding
issues with nested parallelization.</p>
<p>However, in practice, you will probably want to run more that a
single hemisphere vertex-wise analysis, for example, you likely want to
analyse both left and right hemispheres, and possibly assess multiple
models (i.e. looking a more than one brain outcome, or at more than one
set of predictors and so on).</p>
<p>You can do this <em>sequentially</em> of course, just by calling the
<code>run_vw_*()"</code> multiple times with varying specifications. But
if you have a large number of analyses to run, this can quickly become
time-consuming.</p>
<p>So here are some tips on running multiple <code>verywise</code>
analyses <em>in parallel</em>, using <strong>SLURM job arrays</strong>
(since this is a common setup on HPC clusters).</p>
<div class="section level3">
<h3 id="create-a-list-of-analysis-specifications">1. Create a list of analysis specifications<a class="anchor" aria-label="anchor" href="#create-a-list-of-analysis-specifications"></a>
</h3>
<p>First, let’s design our <code>analysis.R</code> script, which will be
called by each job in the SLURM array. This will change quite a bit
depending on your specific analyses, but here is an example of what it
could look like.</p>
<p>We start by defining some constants: things that will be the same
across all the analysises (note: you don’t really <em>need</em> to set
these up as variables, but I think it makes the code cleaner and easier
to maintain, and I am in charge here so we do this how I like it).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load verywise</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://seredef.github.io/verywise/">verywise</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define project paths and constants ----------------------------------------------</span></span>
<span></span>
<span><span class="va">proj_dir</span> <span class="op">&lt;-</span> <span class="st">"path/to/main/project/directory"</span></span>
<span></span>
<span><span class="va">fs_home</span> <span class="op">&lt;-</span> <span class="st">"/path/to/FREESURFER_HOME"</span></span>
<span><span class="va">subj_dir</span> <span class="op">&lt;-</span> <span class="st">"path/to/freesurfer/data"</span></span>
<span></span>
<span><span class="va">outp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span>, <span class="st">"results"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pheno_filepath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">proj_dir</span>, <span class="st">'phenotype_clean.rds'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># this part of the formula will be constant across all analyses</span></span>
<span><span class="va">covariates</span> <span class="op">&lt;-</span> <span class="st">'birth_weight + SES + ethnicity'</span> </span>
<span><span class="va">random_effects</span> <span class="op">&lt;-</span> <span class="st">'(1 | id)'</span></span>
<span></span>
<span><span class="co"># Get SLURM parameters ------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">analysis_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">'SLURM_ARRAY_TASK_ID'</span>, unset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">'SLURM_CPUS_PER_TASK'</span>, unset <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note the <code>analysis_id</code> and <code>n_cores</code> variables,
which catch the array task ID and number of CPUs from the SLURM
environment. These are used to select <em>which of our many
analyses</em> to run, and how many resources can be used to run it. We
will define these values in the SLURM job script below.</p>
<p>Now, let’s organise all our analyses into a <strong><em>grid of
analysis specifications</em></strong> (i.e. combinations of hemispheres,
outcomes, models, datasets etc). Each row of this grid will correspond
to a single analysis.</p>
<p>In this example I want to analyse both hemispheres (<code>lh</code>
and <code>rh</code>), three different outcomes (<code>thickness</code>,
<code>area</code> and <code>w_g.pct</code>), and a two model
specifications: one including an interaction between sex and age
(<code>*</code>), and one without this interaction (<code>+</code>).</p>
<p>This gives us a total of <ins>12 analyses</ins> (2 hemispheres x 3
outcomes x 2 models).</p>
<p>The base R function <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> is a useful way to
create such a grid of all possible parameter combinations, but you can
also create this manually if you prefer (for example, if only certain
combinations make sense for you).</p>
<p>We then use the <code>analysis_id</code> variable to select one
specific parameter combination (i.e. a row in the grid) and use that to
define the current analysis. For example, we: a. take the value of
hemisphere (just making sure it is a character string and not a factor);
b. format the outcome variable name correctly (adding the
<code>vw_</code> prefix); c. define the model formula for the current
analysis (e.g. with or without interaction term).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define parameter space ==========================================================</span></span>
<span></span>
<span><span class="va">hemis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lh'</span>,<span class="st">'rh'</span><span class="op">)</span></span>
<span><span class="va">outcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'thickness'</span>, <span class="st">'area'</span>, <span class="st">'w_g.pct'</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'*'</span>, <span class="st">'+'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="st">'hemi'</span><span class="op">=</span><span class="va">hemis</span>, <span class="st">'outc'</span><span class="op">=</span><span class="va">outcs</span>, <span class="st">'mode'</span><span class="op">=</span><span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select and process current parameter combination --------------------------------</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="va">param_grid</span><span class="op">[</span><span class="va">analysis_id</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">hemi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">hemi</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'vw_'</span>, <span class="va">params</span><span class="op">$</span><span class="va">outc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">outc</span>, <span class="st">'~ age'</span>, <span class="va">params</span><span class="op">$</span><span class="va">mode</span>, <span class="st">'sex +'</span>, <span class="va">covariates</span>, <span class="st">'+'</span>, <span class="va">random_effects</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, let’s run the analysis with all our “current”
parameters:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run analysis --------------------------------------------------------------------</span></span>
<span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_vw_lmm.html">run_vw_lmm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">model_spec</span>,</span>
<span>                     subj_dir <span class="op">=</span> <span class="va">subj_dir</span>,</span>
<span>                     outp_dir <span class="op">=</span> <span class="va">outp_dir</span>,</span>
<span>                     hemi <span class="op">=</span> <span class="va">hemi</span>,</span>
<span>                     pheno <span class="op">=</span> <span class="va">pheno_filepath</span>, </span>
<span>                     n_cores <span class="op">=</span> <span class="va">n_cores</span>,</span>
<span>                     FS_HOME <span class="op">=</span> <span class="va">fs_home</span>,</span>
<span>                     save_ss <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-a-job-script">2. Create a job script<a class="anchor" aria-label="anchor" href="#create-a-job-script"></a>
</h3>
<p>All of this was fun, but we still need to create a SLURM job script
(e.g. <code>run_analyses.sh</code>), which will submit the job array to
the scheduler and stuff done for us. Here we will specify how many
analyses we want to run (i.e. the size of the array), and how many
resources to allocate to each job.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#SBATCH --job-name=verywise_job_array</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#SBATCH --array=1-12 # 12 models in total (see above)</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#SBATCH --ntasks=1</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=64   # </span><span class="al">NOTE</span><span class="co"> R limit parallel processes = 124</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#SBATCH --time=1-00:00:00    # 1 day time limit, just to be on the safe side</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#SBATCH --error=analysis_log%a</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#SBATCH --output=analysis_log%a</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#SBATCH --mail-type=</span><span class="re">END</span><span class="co">,FAIL</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#SBATCH --mail-user=your.email@email.com</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co"># Load modules (not always but sometimes necessary on some HPCs) -------------</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="ex">module</span> load R</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co"># Run analyses (in parallel) -------------------------------------------------</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="ex">Rscript</span> analysis.R</span></code></pre></div>
<p>Then, inside your project directory, submit the job array to SLURM
with: <code>sbatch run_analyses.sh</code>.</p>
</div>
<div class="section level3">
<h3 id="performance-tip-1-avoid-implicit-parallelization">Performance tip 1: avoid implicit parallelization<a class="anchor" aria-label="anchor" href="#performance-tip-1-avoid-implicit-parallelization"></a>
</h3>
<p>On some systems, <em>implicit parallelism</em> in low-level matrix
algebra libraries (BLAS/LAPACK) can interfere with explicit
parallelization used internally by <code>verywise</code>, secretly
slowing your analyses down. If you feel like processing is taking too
long for your liking, I recommend disabling these implicit threading
libraries (<ins>before starting R</ins>).</p>
<p>You can do so, for example by setting the following environment
variables in your shell or in your SLURM job script (before calling
<code>Rscript [...]</code>):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="bu">export</span> <span class="va">OPENBLAS_NUM_THREADS</span><span class="op">=</span>1</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="bu">export</span> <span class="va">OMP_NUM_THREADS</span><span class="op">=</span>1</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="bu">export</span> <span class="va">MKL_NUM_THREADS</span><span class="op">=</span>1</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="bu">export</span> <span class="va">VECLIB_MAXIMUM_THREADS</span><span class="op">=</span>1</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="bu">export</span> <span class="va">NUMEXPR_NUM_THREADS</span><span class="op">=</span>1</span></code></pre></div>
<p>Also note that using a very large number of cores (e.g. <strong>&gt;
120</strong>) may sometimes cause worker initialization or other issues
(e.g. R parallel processes limits).</p>
</div>
<div class="section level3">
<h3 id="performance-tip-2-precompute-and-re-use-the-super-subject-matrix">Performance tip 2: precompute and re-use the super-subject
matrix<a class="anchor" aria-label="anchor" href="#performance-tip-2-precompute-and-re-use-the-super-subject-matrix"></a>
</h3>
<p>If you find yourself running multiple analyses on the same dataset
(i.e. <em>same dataset</em> and <em>same brain outcome</em>), you can
save some computation time by pre-computing the “super-subject matrix”
only once, and re-using it across all your analyses.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://seredef.github.io/verywise/">verywise</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">supsubj_dir</span> <span class="op">=</span> <span class="st">"/path/to/save/ss"</span></span>
<span></span>
<span><span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_supersubject.html">build_supersubject</a></span><span class="op">(</span></span>
<span>                  subj_dir <span class="op">=</span> <span class="st">"/path/to/freesurfer/subjects"</span>,</span>
<span>                  folder_ids <span class="op">=</span> <span class="va">pheno</span><span class="op">[</span>, <span class="st">'folder_id'</span><span class="op">]</span>, <span class="co"># assuming 'pheno' is your phenotype data frame</span></span>
<span>                  supsubj_dir <span class="op">=</span> <span class="va">supsubj_dir</span>,</span>
<span>                  measure <span class="op">=</span> <span class="st">"thickness"</span>,</span>
<span>                  hemi <span class="op">=</span> <span class="st">"lh"</span>,</span>
<span>                  fs_template <span class="op">=</span> <span class="st">"fsaverage"</span>,</span>
<span>                  n_cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>Then simply use <code>supsubj_dir</code> as your
<code>subj_dir</code> argument in <code><a href="../reference/run_vw_lmm.html">run_vw_lmm()</a></code>, and we will
do the rest :)</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="section"></h2>
<p>Next article: <a href="05-visualize-results.html">Inspect and
<em>visualize</em> verywise results</a></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Serena Defina, Sander Lamballais, Ryan Muetzel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
